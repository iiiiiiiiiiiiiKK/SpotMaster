import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { getFirestore, doc, onSnapshot, setDoc } from "firebase/firestore";
import { 
  Plus, 
  Trash2, 
  RefreshCw, 
  X,
  Save,
  History,
  Search,
  Zap,
  Wifi,
  WifiOff,
  Calculator,
  CheckCircle2,
  Calendar,
  Settings,
  Upload,
  FileSpreadsheet,
  FileJson,
  FileText,
  ExternalLink,
  Trophy,
  AlertTriangle,
  Anchor,
  Eye,
  EyeOff,
  Activity,
  TrendingDown,
  TrendingUp,
  ShieldAlert,
  Briefcase,
  Target,
  Skull,
  Percent,
  Scale,
  Rocket,
  Cloud,
  Database,
  MessageSquare,
  Key,
  DownloadCloud,
  Loader2,
  Check
} from 'lucide-react';

/* --- 1. é™æ€çƒ­é—¨å¸ --- */
const POPULAR_COINS = [
  { symbol: 'BTC', name: 'Bitcoin', id: 'bitcoin' },
  { symbol: 'ETH', name: 'Ethereum', id: 'ethereum' },
  { symbol: 'USDT', name: 'Tether', id: 'tether' },
  { symbol: 'BNB', name: 'BNB', id: 'binancecoin' },
  { symbol: 'SOL', name: 'Solana', id: 'solana' },
  { symbol: 'XRP', name: 'XRP', id: 'ripple' },
  { symbol: 'USDC', name: 'USDC', id: 'usd-coin' },
  { symbol: 'DOGE', name: 'Dogecoin', id: 'dogecoin' },
  { symbol: 'ADA', name: 'Cardano', id: 'cardano' },
  { symbol: 'AVAX', name: 'Avalanche', id: 'avalanche-2' },
  { symbol: 'SHIB', name: 'Shiba Inu', id: 'shiba-inu' },
  { symbol: 'DOT', name: 'Polkadot', id: 'polkadot' },
  { symbol: 'LINK', name: 'Chainlink', id: 'chainlink' },
  { symbol: 'TRX', name: 'TRON', id: 'tron' },
  { symbol: 'MATIC', name: 'Polygon', id: 'matic-network' },
  { symbol: 'LTC', name: 'Litecoin', id: 'litecoin' },
  { symbol: 'NEAR', name: 'NEAR Protocol', id: 'near' },
  { symbol: 'UNI', name: 'Uniswap', id: 'uniswap' },
  { symbol: 'ICP', name: 'Internet Computer', id: 'internet-computer' },
  { symbol: 'APT', name: 'Aptos', id: 'aptos' },
  { symbol: 'FIL', name: 'Filecoin', id: 'filecoin' },
  { symbol: 'ATOM', name: 'Cosmos Hub', id: 'cosmos' },
  { symbol: 'ARB', name: 'Arbitrum', id: 'arbitrum' },
  { symbol: 'RNDR', name: 'Render', id: 'render-token' },
  { symbol: 'OP', name: 'Optimism', id: 'optimism' },
  { symbol: 'PEPE', name: 'Pepe', id: 'pepe' },
  { symbol: 'ORDI', name: 'Ordinals', id: 'ordinals' },
  { symbol: 'SATS', name: 'SATS', id: 'sats-ordinals' },
  { symbol: 'WIF', name: 'dogwifhat', id: 'dogwifhat' },
  { symbol: 'BONK', name: 'Bonk', id: 'bonk' },
  { symbol: 'FLOKI', name: 'Floki', id: 'floki' },
  { symbol: 'CFX', name: 'Conflux', id: 'conflux-token' },
  { symbol: 'OPEN', name: 'Open', id: 'open-platform' },
  { symbol: 'DOLO', name: 'Dolomite', id: 'dolomite' },
  { symbol: 'TURBO', name: 'Turbo', id: 'turbo' },
];

/* --- 2. é¢œè‰²æ˜ å°„è¡¨ --- */
const COIN_COLORS = {
  BTC: '#F7931A', // Bitcoin Orange
  ETH: '#627EEA', // Ethereum Blue
  USDT: '#26A17B', // Cash Green
  USDC: '#26A17B', // Cash Green
  DAI: '#26A17B',  // Cash Green
  SOL: '#9945FF', // Solana Purple
  BNB: '#F3BA2F',
  XRP: '#23292F',
  ADA: '#0033AD',
  DOGE: '#C2A633',
  DOT: '#E6007A',
};

const DEFAULT_PALETTE = [
  '#FF0055', '#0033FF', '#FFCC00', '#00CC66', '#CC00FF', '#00FFFF', '#FF6600',
];

/* --- 3. ç­–ç•¥æ ‡ç­¾å®šä¹‰ --- */
const STRATEGY_TAGS = [
  { id: 'DCA', label: 'å®šæŠ•', color: '#10B981', icon: Activity },
  { id: 'SWING', label: 'æ³¢æ®µ', color: '#3B82F6', icon: TrendingUp },
  { id: 'FOMO', label: 'è¿½æ¶¨', color: '#F59E0B', icon: Zap },
  { id: 'YOLO', label: 'æ¢­å“ˆ', color: '#EF4444', icon: Skull },
];

/* --- åƒç´ é£ CSS --- */
const PixelStyles = () => (
  <style>{`
    .pixel-box {
      background: white;
      border: 4px solid #1a1a1a;
      box-shadow: 6px 6px 0px 0px #1a1a1a;
      border-radius: 8px;
      position: relative;
    }
    
    .pixel-btn {
      border: 2px solid #1a1a1a;
      box-shadow: 3px 3px 0px 0px #1a1a1a;
      transition: transform 0.1s, box-shadow 0.1s;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      border-radius: 6px;
    }
    
    .pixel-btn:active {
      transform: translate(3px, 3px);
      box-shadow: 0px 0px 0px 0px #1a1a1a;
    }

    .pixel-btn.primary {
      background: #1a1a1a;
      color: white;
      box-shadow: 3px 3px 0px 0px #666;
    }

    .pixel-input {
      border: 2px solid #1a1a1a;
      background: white;
      padding: 0 10px; 
      height: 40px;    
      line-height: 36px;
      outline: none;
      width: 100%;
      font-family: ui-monospace, SFMono-Regular, monospace;
      font-size: 1rem;
      display: block; 
      border-radius: 6px;
      box-shadow: 3px 3px 0px 0px #1a1a1a; 
      transition: all 0.1s;
    }
    
    .pixel-input:focus {
      background: #f8fafc;
      border-color: #000;
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0px 0px #1a1a1a;
    }
    
    .code-block {
      background: #f1f5f9;
      border: 2px solid #cbd5e1;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.75rem;
      color: #475569;
      margin-bottom: 12px;
    }
    
    .alloc-segment {
      height: 100%;
      border-right: 2px solid #1a1a1a; 
    }
    .alloc-segment:last-child { border-right: none; }
    
    .blur-value {
      filter: blur(6px);
      user-select: none;
      transition: filter 0.2s;
    }
    .blur-value:hover {
      filter: blur(3px);
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
      margin-top: -8px;
      box-shadow: 2px 2px 0px 0px #000;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #000;
      border-radius: 2px;
    }

    .wr-tab {
      padding: 8px;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      opacity: 0.5;
      transition: all 0.2s;
    }
    .wr-tab.active {
      opacity: 1;
      border-bottom: 2px solid black;
      font-weight: bold;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: #eee; }
  `}</style>
);

const INITIAL_ASSETS = [
  { 
    id: 1, 
    symbol: 'BTC', 
    cgId: 'bitcoin', 
    transactions: [
      { id: 't1', type: 'BUY', price: 68000, amount: 0.1, date: '2024-12-01', strategy: 'DCA' },
    ]
  },
  { 
    id: 2, 
    symbol: 'USDT', 
    cgId: 'tether', 
    transactions: [
      { id: 't2', type: 'BUY', price: 1, amount: 5000, date: '2024-12-01', strategy: 'DCA' },
    ]
  }
];

// --- Helper: Smart JSON Parser for Firebase Config ---
// Can handle standard JSON, JS Objects (no key quotes), and Firebase Console snippets
const smartParseFirebaseConfig = (input) => {
  if (!input) return null;
  let clean = input.trim();
  
  // 1. Extract object if wrapped in "const x = { ... }"
  const firstBrace = clean.indexOf('{');
  const lastBrace = clean.lastIndexOf('}');
  if (firstBrace === -1 || lastBrace === -1) throw new Error("No object found ({...})");
  
  clean = clean.substring(firstBrace, lastBrace + 1);

  // 2. JS Object to JSON conversion attempts
  // Replace keys:  apiKey:  ->  "apiKey":
  // Regex: Find word characters followed by colon, NOT starting with a quote
  // This is a naive heuristic but works for standard config objects
  clean = clean.replace(/([{,]\s*)([a-zA-Z0-9_$]+)\s*:/g, '$1"$2":');
  
  // 3. Replace single quotes values with double quotes
  // 'value' -> "value"
  clean = clean.replace(/:\s*'([^']+)'/g, ': "$1"');
  
  // 4. Remove trailing commas (JSON doesn't allow them)
  clean = clean.replace(/,\s*}/g, '}');

  return JSON.parse(clean);
};

// --- War Room Sub-Components (Unchanged) ---
const WarRoomTool_Position = () => {
  const [riskAmt, setRiskAmt] = useState('');
  const [entry, setEntry] = useState('');
  const [stop, setStop] = useState('');
  
  const size = useMemo(() => {
    if(!riskAmt || !entry || !stop) return 0;
    const r = parseFloat(riskAmt);
    const e = parseFloat(entry);
    const s = parseFloat(stop);
    const diff = Math.abs(e - s);
    if(diff === 0) return 0;
    return r / diff; 
  }, [riskAmt, entry, stop]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-yellow-50 p-3 border-2 border-yellow-200 text-xs text-yellow-800 font-bold flex items-center gap-2">
        <Scale size={16}/> äºæŸå®šé¢åæ¨ä»“ä½
      </div>
      <div className="grid grid-cols-2 gap-4">
         <div><label className="text-[10px] font-bold text-gray-500">é£é™©é‡‘é¢ ($)</label><input type="number" className="pixel-input" placeholder="100" value={riskAmt} onChange={e=>setRiskAmt(e.target.value)} /></div>
         <div><label className="text-[10px] font-bold text-gray-500">å¼€ä»“ä»·æ ¼</label><input type="number" className="pixel-input" placeholder="60000" value={entry} onChange={e=>setEntry(e.target.value)} /></div>
         <div className="col-span-2"><label className="text-[10px] font-bold text-gray-500">æ­¢æŸä»·æ ¼</label><input type="number" className="pixel-input" placeholder="58000" value={stop} onChange={e=>setStop(e.target.value)} /></div>
      </div>
      <div className="bg-black text-white p-4 border-2 border-black mt-4">
         <div className="text-xs opacity-70 mb-1">å»ºè®®å¼€ä»“æ•°é‡ (Units)</div>
         <div className="text-3xl font-black text-green-400">{size > 0 ? size.toFixed(4) : '---'}</div>
      </div>
    </div>
  )
};

const WarRoomTool_Kelly = () => {
  const [winRate, setWinRate] = useState(50);
  const [odds, setOdds] = useState(2); 
  
  const kelly = useMemo(() => {
    const p = winRate / 100;
    const q = 1 - p;
    const b = odds;
    return ((b * p - q) / b) * 100;
  }, [winRate, odds]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-blue-50 p-3 border-2 border-blue-200 text-xs text-blue-800 font-bold flex items-center gap-2">
        <Percent size={16}/> å‡¯åˆ©å…¬å¼
      </div>
      <div className="grid grid-cols-2 gap-4">
         <div>
            <label className="text-[10px] font-bold text-gray-500 mb-1 block">èƒœç‡: {winRate}%</label>
            <input type="range" min="1" max="99" value={winRate} onChange={e=>setWinRate(parseInt(e.target.value))} />
         </div>
         <div><label className="text-[10px] font-bold text-gray-500 block mb-1">èµ”ç‡ (1:N)</label><input type="number" className="pixel-input" placeholder="2" value={odds} onChange={e=>setOdds(e.target.value)} /></div>
      </div>
      <div className="bg-black text-white p-4 border-2 border-black mt-4 text-center">
         <div className="text-xs opacity-70 mb-1">å»ºè®®ä»“ä½ %</div>
         <div className={`text-3xl font-black ${kelly > 0 ? 'text-green-400' : 'text-red-500'}`}>{kelly.toFixed(2)}%</div>
      </div>
    </div>
  )
};

const WarRoomTool_Drawdown = () => {
  const [loss, setLoss] = useState(10);
  const gainNeeded = useMemo(() => {
    if (loss >= 100) return 'ğŸ’€';
    return (1 / (1 - (loss / 100)) - 1) * 100;
  }, [loss]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-red-50 p-3 border-2 border-red-200 text-xs text-red-800 font-bold flex items-center gap-2">
        <TrendingDown size={16}/> å›æœ¬éš¾åº¦è®¡ç®—
      </div>
      <div className="py-4">
         <label className="text-xs font-bold text-gray-500 mb-2 block flex justify-between">
            <span>å½“å‰äºæŸ</span>
            <span className="text-red-600">-{loss}%</span>
         </label>
         <input type="range" min="1" max="99" value={loss} onChange={e=>setLoss(parseInt(e.target.value))} />
      </div>
      <div className="flex items-center justify-between bg-gray-100 p-4 border-2 border-gray-300">
          <div className="text-sm font-bold text-gray-500">éœ€æ¶¨å¹…</div>
          <div className="text-3xl font-black text-black">{typeof gainNeeded === 'string' ? gainNeeded : '+' + gainNeeded.toFixed(1) + '%'}</div>
      </div>
    </div>
  )
};

const WarRoomTool_AvgDown = () => {
  const [curQty, setCurQty] = useState('');
  const [curAvg, setCurAvg] = useState('');
  const [buyPrice, setBuyPrice] = useState('');
  const [targetAvg, setTargetAvg] = useState(''); 
  
  const neededQty = useMemo(() => {
    const q = parseFloat(curQty);
    const a = parseFloat(curAvg);
    const p = parseFloat(buyPrice);
    const t = parseFloat(targetAvg);
    if (!q || !a || !p || !t) return null;
    if (p >= a) return 0;
    if (t <= p) return 'Impossible';
    if (t >= a) return 0;

    const num = q * (t - a);
    const den = p - t;
    if (den === 0) return 0;
    const result = num / den;
    return result > 0 ? result : 0;
  }, [curQty, curAvg, buyPrice, targetAvg]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-gray-50 p-3 border-2 border-gray-200 text-xs text-gray-800 font-bold flex items-center gap-2">
        <Target size={16}/> è¡¥ä»“è®¡ç®—å™¨
      </div>
      <div className="grid grid-cols-2 gap-3">
         <div><label className="text-[10px] font-bold text-gray-500">æŒä»“</label><input type="number" className="pixel-input" placeholder="1000" value={curQty} onChange={e=>setCurQty(e.target.value)} /></div>
         <div><label className="text-[10px] font-bold text-gray-500">å‡ä»·</label><input type="number" className="pixel-input" placeholder="10" value={curAvg} onChange={e=>setCurAvg(e.target.value)} /></div>
         <div><label className="text-[10px] font-bold text-gray-500">è¡¥ä»“ä»·</label><input type="number" className="pixel-input" placeholder="5" value={buyPrice} onChange={e=>setBuyPrice(e.target.value)} /></div>
         <div><label className="text-[10px] font-bold text-gray-500 text-black">ç›®æ ‡å‡ä»·</label><input type="number" className="pixel-input border-black" placeholder="8" value={targetAvg} onChange={e=>setTargetAvg(e.target.value)} /></div>
      </div>
      <div className="bg-black text-white p-4 border-2 border-black mt-4">
         <div className="text-xs opacity-70 mb-1">éœ€è¦ä¹°å…¥æ•°é‡</div>
         <div className="text-3xl font-black text-white">
           {neededQty === 'Impossible' ? 'æ— æ³•å®ç°' : (neededQty ? neededQty.toLocaleString(undefined, {maximumFractionDigits:2}) : '---')}
         </div>
      </div>
    </div>
  )
};

const WarRoomTool_Compound = () => {
  const [principal, setPrincipal] = useState('10000');
  const [rate, setRate] = useState('1'); 
  const [days, setDays] = useState('365');
  
  const result = useMemo(() => {
    const p = parseFloat(principal);
    const r = parseFloat(rate) / 100;
    const t = parseFloat(days);
    if (!p || !t) return 0;
    return p * Math.pow((1 + r), t);
  }, [principal, rate, days]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-purple-50 p-3 border-2 border-purple-200 text-xs text-purple-800 font-bold flex items-center gap-2">
        <Rocket size={16}/> å¤åˆ©æ¨æ¼”
      </div>
      <div className="grid grid-cols-3 gap-3">
         <div className="col-span-1"><label className="text-[10px] font-bold text-gray-500">æœ¬é‡‘</label><input type="number" className="pixel-input" value={principal} onChange={e=>setPrincipal(e.target.value)} /></div>
         <div className="col-span-1"><label className="text-[10px] font-bold text-gray-500">æ—¥æ”¶ç›Š%</label><input type="number" className="pixel-input" value={rate} onChange={e=>setRate(e.target.value)} /></div>
         <div className="col-span-1"><label className="text-[10px] font-bold text-gray-500">å¤©æ•°</label><input type="number" className="pixel-input" value={days} onChange={e=>setDays(e.target.value)} /></div>
      </div>
      <div className="bg-black text-white p-4 border-2 border-black mt-4">
         <div className="flex justify-between items-end mb-2">
            <div className="text-xs opacity-70">æœ€ç»ˆèµ„é‡‘</div>
            <div className="text-3xl font-black text-purple-300">${result.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
         </div>
      </div>
    </div>
  )
};

const WarRoomTool_Ruin = () => {
  const [winRate, setWinRate] = useState(40);
  const [riskPerTrade, setRiskPerTrade] = useState(5);
  const [rewardRatio, setRewardRatio] = useState(2); 
  
  const stats = useMemo(() => {
    const w = winRate / 100;
    const l = 1 - w;
    const r = rewardRatio; 
    const ev = (w * r) - (l * 1);
    const stepsToDeath = Math.floor(100 / riskPerTrade);
    return { ev, stepsToDeath, danger: stepsToDeath < 10 ? 'HIGH' : (stepsToDeath < 20 ? 'MED' : 'LOW') };
  }, [winRate, riskPerTrade, rewardRatio]);

  return (
    <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
      <div className="bg-gray-900 text-white p-3 border-2 border-black text-xs font-bold flex items-center gap-2">
        <Skull size={16}/> æ­»äº¡è®¡ç®—å™¨
      </div>
      <div className="grid grid-cols-2 gap-4">
         <div>
            <label className="text-[10px] font-bold text-gray-500 block mb-1">èƒœç‡ (%)</label>
            <input type="number" className="pixel-input" value={winRate} onChange={e=>setWinRate(e.target.value)} />
         </div>
         <div>
            <label className="text-[10px] font-bold text-gray-500 block mb-1">ç›ˆäºæ¯”</label><input type="number" className="pixel-input" value={rewardRatio} onChange={e=>setRewardRatio(e.target.value)} />
         </div>
         <div className="col-span-2">
            <label className="text-[10px] font-bold text-gray-500 block mb-1">å•ç¬”é£é™© ({riskPerTrade}%)</label>
            <input type="range" min="1" max="20" step="1" value={riskPerTrade} onChange={e=>setRiskPerTrade(e.target.value)} className="w-full" />
         </div>
      </div>
      <div className={`p-4 border-2 border-black mt-4 ${stats.ev > 0 ? 'bg-white' : 'bg-red-50'}`}>
         <div className="flex justify-between items-center mb-2">
           <div className="text-xs font-bold text-gray-500">æœŸæœ›å€¼ (EV)</div>
           <div className={`font-bold ${stats.ev > 0 ? 'text-green-600' : 'text-red-600'}`}>{stats.ev > 0 ? '+' : ''}{stats.ev.toFixed(2)} R</div>
         </div>
         <div className="flex justify-between items-center">
            <div className="text-xs font-bold text-gray-500">è¿è´¥çˆ†ä»“æ­¥æ•°</div>
            <div className="font-black text-2xl">{stats.ev <= 0 ? 'å¿…æ­»' : `${stats.stepsToDeath} æ­¥`}</div>
         </div>
      </div>
    </div>
  )
};

export default function PixelTraderV33_SmartConfig() {
  const [assets, setAssets] = useState(INITIAL_ASSETS);
  const [prices, setPrices] = useState({}); 
  const [source, setSource] = useState('binance');
  const [status, setStatus] = useState('idle');
  const [sortMode, setSortMode] = useState('value');
  
  const [isPrivacyMode, setIsPrivacyMode] = useState(false);
  const [showStressTest, setShowStressTest] = useState(false);
  const [stressPercent, setStressPercent] = useState(0); 
  
  const [isWarRoomOpen, setIsWarRoomOpen] = useState(false);
  const [warRoomTab, setWarRoomTab] = useState('position');

  const [coinDb, setCoinDb] = useState(POPULAR_COINS); 
  const [isDbLoading, setIsDbLoading] = useState(false);
  const [dbStatus, setDbStatus] = useState('basic'); 
  
  const [activeHistoryId, setActiveHistoryId] = useState(null); 
  const [activeCalcId, setActiveCalcId] = useState(null);
  const [isAddingNewCoin, setIsAddingNewCoin] = useState(false); 
  const [isImporting, setIsImporting] = useState(false); 
  
  // Renamed isGlobalBackup to isSettingsOpen to reflect added features
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [settingsTab, setSettingsTab] = useState('data'); // 'data' or 'cloud'
  
  const [newCoinSearch, setNewCoinSearch] = useState('');
  const [selectedCoin, setSelectedCoin] = useState(null);
  const [addError, setAddError] = useState('');
  const [importText, setImportText] = useState(''); 
  const [importPreview, setImportPreview] = useState(null); // Array of parsed objects for preview
  
  const [txForm, setTxForm] = useState({ 
    type: 'BUY', 
    price: '', 
    amount: '', 
    date: new Date().toISOString().split('T')[0],
    strategy: 'DCA' 
  });
  
  const [calcMode, setCalcMode] = useState('amount');
  const [calcInput, setCalcInput] = useState(''); 
  const [calcPrice, setCalcPrice] = useState('');

  const [deleteConfirmId, setDeleteConfirmId] = useState(null); 
  const [deleteTxConfirmId, setDeleteTxConfirmId] = useState(null); 

  const wsRef = useRef(null);

  // --- CLOUD CONFIG STATE (BYOK) ---
  const [cloudConfig, setCloudConfig] = useState({
    firebaseConfig: '',
    tgToken: '',
    tgChatId: ''
  });
  
  // NEW: Independent Input States for Debounce & Smart Parsing
  const [firebaseConfigInput, setFirebaseConfigInput] = useState('');
  const [firebaseParseError, setFirebaseParseError] = useState(null);
  
  const [firebaseStatus, setFirebaseStatus] = useState('idle'); // idle, connecting, connected, error
  const [tgLastBackup, setTgLastBackup] = useState(null);
  const [isPullingTg, setIsPullingTg] = useState(false);
  
  const dbRef = useRef(null);
  const isRemoteUpdate = useRef(false); // Flag to prevent sync loops
  const assetsRef = useRef(assets); // Ref for current assets in closures

  // --- 1. Load User Data & Cloud Config ---
  useEffect(() => {
    try {
      const savedAssets = localStorage.getItem('pixel_trader_v22');
      if (savedAssets) setAssets(JSON.parse(savedAssets));
      
      const savedConfig = localStorage.getItem('pixel_trader_cloud_config');
      if (savedConfig) {
        const parsed = JSON.parse(savedConfig);
        setCloudConfig(parsed);
        // Initialize input with stored config (string)
        if (parsed.firebaseConfig) setFirebaseConfigInput(parsed.firebaseConfig);
      }
    } catch (e) {}
  }, []);

  useEffect(() => {
    if(!isRemoteUpdate.current) {
        localStorage.setItem('pixel_trader_v22', JSON.stringify(assets));
    }
    assetsRef.current = assets; // Update ref for callbacks
  }, [assets]);

  // Save Cloud Config (Base function)
  const saveCloudConfig = (newConfig) => {
    setCloudConfig(newConfig);
    localStorage.setItem('pixel_trader_cloud_config', JSON.stringify(newConfig));
  };

  // --- NEW: Debounce & Smart Parsing for Firebase Input ---
  useEffect(() => {
    const timer = setTimeout(() => {
        if (!firebaseConfigInput.trim()) {
            // User cleared input, we don't save empty string unless we want to disconnect
            // but let's just clear error
            setFirebaseParseError(null);
            return;
        }

        try {
            // 1. Try Smart Parsing
            const parsedObj = smartParseFirebaseConfig(firebaseConfigInput);
            
            // 2. If successful, stringify to standard JSON
            const standardJson = JSON.stringify(parsedObj);
            
            // 3. Clear errors
            setFirebaseParseError(null);

            // 4. Save to actual config if changed
            if (standardJson !== cloudConfig.firebaseConfig) {
                saveCloudConfig({ ...cloudConfig, firebaseConfig: standardJson });
            }
        } catch (e) {
            setFirebaseParseError("Invalid format: " + e.message + ". Try pasting the full 'const firebaseConfig = ...' block.");
        }
    }, 800); // 800ms Debounce

    return () => clearTimeout(timer);
  }, [firebaseConfigInput, cloudConfig]);


  // --- 2. Firebase Integration Logic (Unchanged Connection Logic) ---
  useEffect(() => {
    if (cloudConfig.firebaseConfig && cloudConfig.firebaseConfig.trim().startsWith('{')) {
      try {
        setFirebaseStatus('connecting');
        const config = JSON.parse(cloudConfig.firebaseConfig);
        // Avoid re-init if already exists? standard firebase app handles singleton mostly, 
        // but for safety in this strict environment, we try-catch re-init.
        let app;
        try {
            app = initializeApp(config);
        } catch(e) {
            if(e.code === 'app/duplicate-app') { 
                console.log("App exists");
            }
        }
        
        if (app) {
             const db = getFirestore(app);
             dbRef.current = db;
             
             // Listen to changes
             const unsub = onSnapshot(doc(db, "pixel_trader", "user_data"), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.assets && JSON.stringify(data.assets) !== JSON.stringify(assetsRef.current)) {
                        console.log("ğŸ”¥ Firebase: Received update");
                        isRemoteUpdate.current = true;
                        setAssets(data.assets);
                        // Reset flag after a tick
                        setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                    }
                }
             }, (error) => {
                 console.error("Firebase Listen Error:", error);
                 setFirebaseStatus('error');
             });
             
             setFirebaseStatus('connected');
             return () => unsub();
        }
      } catch (e) {
        console.error("Firebase Init Failed:", e);
        setFirebaseStatus('error');
      }
    } else {
        setFirebaseStatus('idle');
    }
  }, [cloudConfig.firebaseConfig]);

  // Sync to Firebase on Asset Change (Debounced)
  useEffect(() => {
    if (firebaseStatus === 'connected' && dbRef.current && !isRemoteUpdate.current) {
        const timer = setTimeout(async () => {
            try {
                console.log("ğŸ”¥ Firebase: Syncing up...");
                await setDoc(doc(dbRef.current, "pixel_trader", "user_data"), { 
                    assets, 
                    lastUpdated: new Date().toISOString() 
                });
            } catch (e) {
                console.error("Sync Up Failed", e);
            }
        }, 1000); // 1s debounce
        return () => clearTimeout(timer);
    }
  }, [assets, firebaseStatus]);

  // --- 3. Telegram Integration Logic ---
  // Auto Backup
  useEffect(() => {
    if (cloudConfig.tgToken && cloudConfig.tgChatId && !isRemoteUpdate.current) {
        const timer = setTimeout(async () => {
            try {
                const blob = new Blob([JSON.stringify({ assets, date: new Date().toISOString() }, null, 2)], { type: 'application/json' });
                const formData = new FormData();
                formData.append('chat_id', cloudConfig.tgChatId);
                formData.append('document', blob, `backup_${Date.now()}.json`);
                formData.append('caption', `ğŸ¤– Auto-Backup: ${new Date().toLocaleTimeString()}`);

                await fetch(`https://api.telegram.org/bot${cloudConfig.tgToken}/sendDocument`, {
                    method: 'POST',
                    body: formData
                });
                setTgLastBackup(new Date());
            } catch (e) {
                console.error("TG Backup Failed", e);
            }
        }, 3000); // 3s debounce for TG to avoid spam
        return () => clearTimeout(timer);
    }
  }, [assets, cloudConfig.tgToken, cloudConfig.tgChatId]);

  // Manual Pull from TG (Serverless Command)
  const handleTgPull = async () => {
      if (!cloudConfig.tgToken) return;
      setIsPullingTg(true);
      try {
          // Get Updates
          const res = await fetch(`https://api.telegram.org/bot${cloudConfig.tgToken}/getUpdates?offset=-5`);
          const data = await res.json();
          if (data.ok && data.result.length > 0) {
              // Look for the last message with JSON text
              let foundData = null;
              // Iterate backwards
              for (let i = data.result.length - 1; i >= 0; i--) {
                  const text = data.result[i].message?.text;
                  if (text && (text.startsWith('{') || text.startsWith('['))) {
                      try {
                          const parsed = JSON.parse(text);
                          if (Array.isArray(parsed)) { foundData = parsed; break; }
                          if (parsed.assets && Array.isArray(parsed.assets)) { foundData = parsed.assets; break; }
                      } catch(e) {}
                  }
              }
              
              if (foundData) {
                  if(confirm(`Found data from TG! Overwrite current assets? (${foundData.length} coins)`)) {
                      isRemoteUpdate.current = true;
                      setAssets(foundData);
                      setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                      alert("Successfully updated from Telegram!");
                  }
              } else {
                  alert("No valid JSON data found in recent Telegram messages.");
              }
          }
      } catch (e) {
          alert("Failed to pull from TG");
      } finally {
          setIsPullingTg(false);
      }
  };

  // --- 4. Infinite Coin DB Logic ---
  useEffect(() => {
    const cachedDb = localStorage.getItem('pixel_trader_full_coin_db');
    const cachedTime = localStorage.getItem('pixel_trader_db_time');
    const now = Date.now();

    if (cachedDb && cachedTime && (now - parseInt(cachedTime) < 24 * 60 * 60 * 1000)) {
      try {
        const fullList = JSON.parse(cachedDb);
        setCoinDb(fullList);
        setDbStatus('full');
      } catch(e) {
        fetchFullCoinList();
      }
    } else {
      fetchFullCoinList();
    }
  }, []);

  const fetchFullCoinList = async () => {
    setIsDbLoading(true);
    try {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/list?include_platform=false');
      if (!res.ok) throw new Error('Failed to fetch');
      const data = await res.json();
      const popularIds = new Set(POPULAR_COINS.map(c => c.id));
      const others = data.filter(c => !popularIds.has(c.id));
      const fullList = [...POPULAR_COINS, ...others];
      setCoinDb(fullList);
      setDbStatus('full');
      localStorage.setItem('pixel_trader_full_coin_db', JSON.stringify(fullList));
      localStorage.setItem('pixel_trader_db_time', Date.now().toString());
    } catch (err) { } finally {
      setIsDbLoading(false);
    }
  };

  // --- 5. Data Source (Price) ---
  useEffect(() => {
    if (wsRef.current) { wsRef.current.close(); wsRef.current = null; }
    setPrices({});
    if (source === 'binance') connectBinance();
    else if (source === 'coingecko') fetchCoinGecko();
    else if (source === 'cryptocompare') fetchCryptoCompare();
    return () => wsRef.current?.close();
  }, [source, assets]);

  const connectBinance = () => {
    setStatus('connecting');
    try {
      const ws = new WebSocket('wss://stream.binance.com:9443/ws/!miniTicker@arr');
      ws.onopen = () => setStatus('connected');
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const newPrices = {};
          const watchList = new Set(assets.map(a => `${a.symbol.toUpperCase()}USDT`));
          let hasUpdate = false;
          data.forEach(t => {
            if (watchList.has(t.s)) {
              newPrices[t.s.replace('USDT', '')] = parseFloat(t.c);
              hasUpdate = true;
            }
          });
          if (hasUpdate) setPrices(prev => ({ ...prev, ...newPrices }));
        } catch(e) {}
      };
      ws.onclose = () => setStatus('disconnected');
      wsRef.current = ws;
    } catch (e) { setStatus('error'); }
  };

  const fetchCoinGecko = async () => {
    setStatus('loading');
    try {
      const ids = assets.map(a => a.cgId).filter(id => id).join(',');
      if (!ids) { setStatus('idle'); return; }
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
      const data = await res.json();
      const newPrices = {};
      assets.forEach(asset => {
        if (asset.cgId && data[asset.cgId]?.usd) {
          newPrices[asset.symbol] = data[asset.cgId].usd;
        }
      });
      setPrices(newPrices);
      setStatus('connected');
    } catch (err) { setStatus('error'); }
  };

  const fetchCryptoCompare = async () => {
    setStatus('loading');
    try {
      const symbols = assets.map(a => a.symbol.toUpperCase()).join(',');
      if (!symbols) { setStatus('idle'); return; }
      const res = await fetch(`https://min-api.cryptocompare.com/data/pricemulti?fsyms=${symbols}&tsyms=USD`);
      const data = await res.json();
      const newPrices = {};
      assets.forEach(asset => {
        const sym = asset.symbol.toUpperCase();
        if (data[sym] && data[sym].USD) {
          newPrices[asset.symbol] = data[sym].USD;
        }
      });
      setPrices(newPrices);
      setStatus('connected');
    } catch (err) { setStatus('error'); }
  };

  // --- Core Calculation ---
  const calculatePosition = (transactions) => {
    let currentAmount = 0;
    let totalCost = 0; 
    let realizedPnL = 0; 
    
    const sortedTxs = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

    sortedTxs.forEach(tx => {
      const price = parseFloat(tx.price);
      const amount = parseFloat(tx.amount);
      if (tx.type === 'BUY') {
        currentAmount += amount;
        totalCost += (price * amount);
      } else if (tx.type === 'SELL') {
        if (currentAmount > 0) {
          const avgCost = totalCost / currentAmount;
          realizedPnL += (price - avgCost) * amount;
          totalCost -= (avgCost * amount);
          currentAmount -= amount;
        }
      }
    });

    currentAmount = Math.max(0, currentAmount);
    const avgPrice = currentAmount > 0 ? totalCost / currentAmount : 0;
    return { currentAmount, avgPrice, realizedPnL, totalCost };
  };

  const getDCAProjection = (asset) => {
    if (!calcPrice || !calcInput) return null;
    const { currentAmount, avgPrice, totalCost } = calculatePosition(asset.transactions);
    const inputVal = parseFloat(calcInput);
    const priceVal = parseFloat(calcPrice);
    
    if (calcMode === 'risk_free') {
      if (priceVal <= 0) return null;
      const amountToSell = totalCost / priceVal;
      const isProfitable = priceVal > avgPrice;
      return { type: 'risk_free', amountToSell, remainingAmount: currentAmount - amountToSell, isProfitable };
    }

    let buyAmount = 0;
    let buyCost = 0;
    if (calcMode === 'amount') {
      buyCost = inputVal;
      buyAmount = inputVal / priceVal;
    } else {
      buyAmount = inputVal;
      buyCost = inputVal * priceVal;
    }
    const totalAmount = currentAmount + buyAmount;
    const newTotalCost = (currentAmount * avgPrice) + buyCost;
    const newAvg = newTotalCost / totalAmount;

    return {
      type: 'dca', newAvg, buyAmount, buyCost,
      drop: avgPrice > 0 ? ((avgPrice - newAvg) / avgPrice) * 100 : 0
    };
  };

  const handleGlobalBackup = () => {
    const data = { version: 'v33_cloud', timestamp: new Date().toISOString(), assets: assets };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pixel_trader_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  const handleGlobalRestore = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (data.assets) {
          if (confirm(`Restore ${data.assets.length} assets?`)) {
            setAssets(data.assets);
            alert("Restored successfully!");
          }
        }
      } catch (err) { alert('Error parsing file'); }
    };
    reader.readAsText(file);
  };

  const selectCoin = (coin) => { setSelectedCoin(coin); setNewCoinSearch(''); setAddError(''); };
  const confirmAddCoin = () => {
    if (!selectedCoin) return;
    if (assets.find(a => a.symbol === selectedCoin.symbol)) { setAddError(`Asset Exists!`); return; }
    const newAsset = { id: Date.now(), symbol: selectedCoin.symbol.toUpperCase(), cgId: selectedCoin.id, transactions: [] };
    setAssets([...assets, newAsset]); setIsAddingNewCoin(false); setNewCoinSearch(''); setSelectedCoin(null); setActiveHistoryId(newAsset.id);
  };
  
  const handleAddTx = () => {
    if (!txForm.price || !txForm.amount) return;
    const newTx = { 
      id: Date.now().toString(), 
      type: txForm.type, 
      price: parseFloat(txForm.price), 
      amount: parseFloat(txForm.amount), 
      date: txForm.date,
      strategy: txForm.strategy || 'DCA'
    };
    setAssets(assets.map(a => a.id === activeHistoryId ? { ...a, transactions: [...a.transactions, newTx] } : a));
    setTxForm({ ...txForm, price: '', amount: '' }); 
  };
  
  const handleDeleteAsset = (id) => { if (deleteConfirmId === id) { setAssets(assets.filter(a => a.id !== id)); setDeleteConfirmId(null); setActiveHistoryId(null); } else { setDeleteConfirmId(id); setTimeout(() => setDeleteConfirmId(null), 3000); } };
  const handleDeleteTx = (assetId, txId) => { if (deleteTxConfirmId === txId) { setAssets(assets.map(a => a.id === assetId ? { ...a, transactions: a.transactions.filter(t => t.id !== txId) } : a)); setDeleteTxConfirmId(null); } else { setDeleteTxConfirmId(txId); setTimeout(() => setDeleteTxConfirmId(null), 3000); } };
  
  const handleExport = (format) => {
    const asset = assets.find(a => a.id === activeHistoryId);
    if (!asset) return;
    const data = asset.transactions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(tx => ({
      date: tx.date, type: tx.type === 'BUY' ? 'ä¹°' : 'å–', price: tx.price, amount: tx.amount
    }));
    let content = format === 'json' ? JSON.stringify(data, null, 2) : 
      `| æ—¥æœŸ | ç±»å‹ | ä»·æ ¼ | æ•°é‡ |\n|---|---|---|---|\n` + data.map(row => `| ${row.date} | ${row.type} | ${row.price} | ${row.amount} |`).join('\n');
    const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${asset.symbol}.${format}`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  const parseImportText = (text) => {
    const lines = text.split('\n').filter(line => line.trim().length > 0);
    const parsed = [];
    
    // Attempt JSON parse first
    try {
        const json = JSON.parse(text);
        if (Array.isArray(json)) {
             json.forEach(item => {
                 if (item.date && item.price && item.amount) {
                     parsed.push({
                         id: Math.random().toString(),
                         date: item.date,
                         type: ['å–','SELL','sell'].includes(item.type) ? 'SELL' : 'BUY',
                         price: parseFloat(item.price),
                         amount: parseFloat(item.amount),
                         strategy: 'DCA'
                     });
                 }
             });
             return parsed;
        }
    } catch(e) {}

    // Fallback to CSV/TSV
    // Heuristic: Try to find header line to map columns
    // Default Map: Date, Type, Price, Amount
    lines.forEach(line => {
       // Skip potential header lines if they contain text like 'Date' or 'Price'
       if (line.toLowerCase().includes('date') && line.toLowerCase().includes('price')) return;

       // Split by tab, comma, or semicolon
       const cols = line.split(/[,\t;]+/).map(s => s.trim());
       
       // Clean currency symbols from potential price/amount fields
       // We assume last two numeric-ish columns are price and amount
       // Or strictly follow 4 column structure
       if (cols.length >= 4) {
           let type = 'BUY';
           const rawType = cols[1].toLowerCase();
           if (rawType.includes('sell') || rawType.includes('å–')) type = 'SELL';
           
           const cleanNum = (str) => parseFloat(str.replace(/[^\d.-]/g, ''));
           
           const price = cleanNum(cols[2]);
           const amount = cleanNum(cols[3]);
           
           if (!isNaN(price) && !isNaN(amount)) {
               parsed.push({
                   id: Math.random().toString(),
                   date: cols[0],
                   type,
                   price,
                   amount,
                   strategy: 'DCA'
               });
           }
       }
    });
    return parsed;
  };

  const handlePreview = () => {
    if (!importText) return;
    const result = parseImportText(importText);
    setImportPreview(result);
  };

  const handleConfirmImport = () => {
    if (importPreview && importPreview.length > 0) {
      setAssets(assets.map(a => a.id === activeHistoryId ? { ...a, transactions: [...a.transactions, ...importPreview] } : a));
      setIsImporting(false); 
      setImportText('');
      setImportPreview(null);
    }
  };

  const filteredCoins = useMemo(() => {
    if (!newCoinSearch || newCoinSearch.length < 2) return [];
    const search = newCoinSearch.toLowerCase();
    return coinDb.filter(c => c.symbol.toLowerCase().includes(search) || c.name.toLowerCase().includes(search))
      .sort((a, b) => 0).slice(0, 50);
  }, [newCoinSearch, coinDb]);

  const assetCalculations = useMemo(() => {
    return assets.map(asset => {
      const { currentAmount, avgPrice, realizedPnL } = calculatePosition(asset.transactions);
      const currentPrice = prices[asset.symbol] || 0;
      const marketValue = currentAmount * currentPrice;
      const unrealizedPnL = marketValue - (currentAmount * avgPrice);
      const roi = avgPrice > 0 ? (currentPrice / avgPrice) : 0;
      return { 
        ...asset, 
        currentAmount, 
        avgPrice, 
        realizedPnL, 
        currentPrice, 
        marketValue, 
        unrealizedPnL,
        roi 
      };
    });
  }, [assets, prices]);

  const totalStats = assetCalculations.reduce((acc, asset) => ({
    totalValue: acc.totalValue + asset.marketValue,
    totalRealized: acc.totalRealized + asset.realizedPnL,
    totalUnrealized: acc.totalUnrealized + asset.unrealizedPnL
  }), { totalValue: 0, totalRealized: 0, totalUnrealized: 0 });

  const simulatedStats = useMemo(() => {
    if (stressPercent === 0) return totalStats;
    const factor = 1 + (stressPercent / 100);
    const simulatedValue = assetCalculations.reduce((acc, asset) => {
       const isStable = ['USDT', 'USDC', 'DAI'].includes(asset.symbol);
       const assetFactor = isStable ? 1 : factor; 
       return acc + (asset.marketValue * assetFactor);
    }, 0);
    
    return {
       ...totalStats,
       projectedValue: simulatedValue,
       diff: simulatedValue - totalStats.totalValue
    };
  }, [totalStats, stressPercent, assetCalculations]);

  const sortedAssets = useMemo(() => {
    const list = [...assetCalculations];
    if (sortMode === 'value') return list.sort((a, b) => b.marketValue - a.marketValue);
    if (sortMode === 'pnl') return list.sort((a, b) => b.unrealizedPnL - a.unrealizedPnL);
    if (sortMode === 'name') return list.sort((a, b) => a.symbol.localeCompare(b.symbol));
    return list;
  }, [assetCalculations, sortMode]);

  const getAssetColor = (symbol, index) => {
    if (COIN_COLORS[symbol]) return COIN_COLORS[symbol];
    return DEFAULT_PALETTE[index % DEFAULT_PALETTE.length];
  };

  const MaskedValue = ({ value, prefix = '$', className = '' }) => {
    if (isPrivacyMode) return <span className={`text-gray-400 font-mono tracking-widest select-none ${className}`}>****</span>;
    return <span className={className}>{prefix}{value}</span>;
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 font-mono text-gray-900 flex justify-center items-start">
      <PixelStyles />
      
      <div className="w-full max-w-2xl space-y-6 pb-20">
        
        {/* === Header === */}
        <div className="flex flex-col gap-4">
          <div className="flex justify-between items-center border-b-4 border-gray-900 pb-2">
            <div>
              <h1 className="text-3xl font-black uppercase tracking-tighter leading-none mb-1">Pixel Trader</h1>
              <a href="https://x.com/0xkillcoin" target="_blank" rel="noopener noreferrer"
                className="text-[10px] bg-black text-white px-2 py-0.5 font-bold inline-flex items-center gap-1 hover:opacity-80">
                @0xKillCoin <ExternalLink size={8} />
              </a>
            </div>
            
            <div className="flex items-center gap-3">
               <div className="flex items-center gap-1 text-xs font-bold">
                  {status === 'connected' ? <Wifi size={14}/> : <WifiOff size={14}/>}
                  <span className={status === 'connected' ? 'text-green-600' : 'text-red-500'}>
                    {status === 'connected' ? 'ON' : 'OFF'}
                  </span>
               </div>
               
               <button onClick={() => setIsWarRoomOpen(true)} className="pixel-btn w-8 h-8 flex items-center justify-center shadow-none bg-white hover:bg-gray-100 border-2 border-black" title="War Room">
                 <Briefcase size={18} />
               </button>

               <button onClick={() => setIsPrivacyMode(!isPrivacyMode)} className="pixel-btn w-8 h-8 flex items-center justify-center shadow-none bg-white hover:bg-gray-100" title={isPrivacyMode ? "Show Values" : "Hide Values (Privacy Mode)"}>
                 {isPrivacyMode ? <EyeOff size={18} /> : <Eye size={18} />}
               </button>

               <button onClick={() => setIsSettingsOpen(true)} className={`pixel-btn w-8 h-8 flex items-center justify-center shadow-none hover:bg-gray-100 ${firebaseStatus==='connected' ? 'bg-green-100 border-green-500' : 'bg-white'}`}>
                 <Settings size={18} className={firebaseStatus==='connected'?'text-green-700':'text-black'}/>
               </button>
            </div>
          </div>
          
          <div className="flex items-center justify-between bg-white border-2 border-gray-900 p-2">
            <div className="flex gap-2">
               <button onClick={() => setSource('binance')} className={`pixel-btn bg-white px-2 py-1 text-[10px] ${source === 'binance' ? 'primary !bg-black !text-white' : ''}`}>[A] BINANCE</button>
               <button onClick={() => setSource('coingecko')} className={`pixel-btn bg-white px-2 py-1 text-[10px] ${source === 'coingecko' ? 'primary !bg-black !text-white' : ''}`}>[B] GECKO</button>
               <button onClick={() => setSource('cryptocompare')} className={`pixel-btn bg-white px-2 py-1 text-[10px] ${source === 'cryptocompare' ? 'primary !bg-black !text-white' : ''}`}>[C] CRYPTO</button>
            </div>
            {(source === 'coingecko' || source === 'cryptocompare') && <button onClick={source === 'coingecko' ? fetchCoinGecko : fetchCryptoCompare}><RefreshCw size={14}/></button>}
          </div>
        </div>

        {/* === Stress Test / Total Stats === */}
        <div className="pixel-box p-4 bg-white transition-all duration-300">
          <div className="flex justify-between items-start mb-2">
             <div className="text-gray-500 text-xs font-bold">TOTAL EQUITY</div>
             <button 
                onClick={() => { setShowStressTest(!showStressTest); setStressPercent(0); }} 
                className={`pixel-btn px-2 py-0.5 text-[10px] font-bold ${showStressTest ? '!bg-black !text-white' : 'bg-gray-100 text-gray-500'}`}
             >
                <Activity size={12} className="mr-1"/> STRESS TEST
             </button>
          </div>

          <div className="flex items-baseline gap-2 mb-4">
             <div className="text-4xl font-black">
                <MaskedValue value={showStressTest && stressPercent !== 0 ? simulatedStats.projectedValue.toLocaleString(undefined, { maximumFractionDigits: 0 }) : totalStats.totalValue.toLocaleString(undefined, { maximumFractionDigits: 0 })} />
             </div>
             {showStressTest && stressPercent !== 0 && (
                <div className={`text-sm font-bold ${simulatedStats.diff >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                   ({simulatedStats.diff > 0 ? '+' : ''}<MaskedValue value={simulatedStats.diff.toLocaleString(undefined, { maximumFractionDigits: 0 })} prefix="$" />)
                </div>
             )}
          </div>
          
          {showStressTest && (
             <div className="mb-4 bg-gray-50 border-2 border-black p-4 animate-in slide-in-from-top-2 rounded-md flex flex-col items-center text-center">
                <div className="text-xs font-bold mb-2 flex flex-col items-center">
                   <span className="text-gray-400 mb-1">SCENARIO SIMULATION</span>
                   <span className={`text-xl ${stressPercent > 0 ? 'text-green-600' : (stressPercent < 0 ? 'text-red-600' : 'text-black')}`}>
                     {stressPercent > 0 ? '+' : ''}{stressPercent}%
                   </span>
                </div>
                
                <input 
                  type="range" 
                  min="-80" 
                  max="80" 
                  step="5"
                  value={stressPercent} 
                  onChange={(e) => setStressPercent(parseInt(e.target.value))} 
                  className="w-full mb-4 max-w-xs"
                />
                
                <div className="flex justify-center gap-2 w-full">
                   <button onClick={() => setStressPercent(-50)} className="pixel-btn bg-white px-3 py-1 text-[10px] hover:bg-red-50 text-red-600 border-red-200"><TrendingDown size={12} className="mr-1"/> CRASH -50%</button>
                   <button onClick={() => setStressPercent(0)} className="pixel-btn bg-white px-3 py-1 text-[10px] hover:bg-gray-50 text-gray-600 border-gray-200">RESET 0%</button>
                   <button onClick={() => setStressPercent(50)} className="pixel-btn bg-white px-3 py-1 text-[10px] hover:bg-green-50 text-green-600 border-green-200"><TrendingUp size={12} className="mr-1"/> MOON +50%</button>
                </div>
             </div>
          )}

          <div className="mb-2">
            <div className="flex justify-between items-end mb-1">
               <div className="text-[10px] font-bold text-gray-400">ALLOCATION</div>
               {(() => {
                  const stableValue = sortedAssets.filter(a => ['USDT','USDC','DAI'].includes(a.symbol)).reduce((acc,a)=>acc+a.marketValue,0);
                  const stablePct = totalStats.totalValue > 0 ? (stableValue / totalStats.totalValue) * 100 : 0;
                  if (totalStats.totalValue > 0 && stablePct < 10) {
                     return <div className="text-[10px] font-bold text-red-600 flex items-center gap-1 animate-pulse"><ShieldAlert size={10}/> LOW AMMO ({stablePct.toFixed(0)}%)</div>
                  }
               })()}
            </div>
            <div className="flex w-full h-6 border-4 border-black bg-gray-100 mb-2">
              {sortedAssets.filter(a => a.marketValue > 0).map((asset, idx) => {
                const percent = (asset.marketValue / totalStats.totalValue) * 100;
                if (percent < 1) return null;
                const bg = getAssetColor(asset.symbol, idx);
                return (
                  <div key={asset.id} className="alloc-segment relative group" style={{ width: `${percent}%`, backgroundColor: bg }}></div>
                );
              })}
            </div>

            <div className="flex gap-4 text-xs font-bold text-gray-600 overflow-hidden h-5 items-center">
               <div className="bg-black text-white px-1 text-[10px]">X-RAY</div>
               {sortedAssets.filter(a => a.marketValue > 0).slice(0, 4).map((asset, idx) => {
                  const percent = (asset.marketValue / totalStats.totalValue) * 100;
                  const color = getAssetColor(asset.symbol, idx);
                  return (
                    <div key={asset.id} className="flex items-center gap-1 whitespace-nowrap">
                       <div className="w-2 h-2" style={{backgroundColor: color}}></div>
                       <span>{Math.round(percent)}% {asset.symbol}</span>
                    </div>
                  )
               })}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4 border-t-2 border-dashed border-gray-300 pt-4">
            <div>
              <div className="text-xs text-gray-500 font-bold mb-1">UNREALIZED (æµ®ç›ˆ)</div>
              <div className={`text-xl font-bold ${totalStats.totalUnrealized >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {totalStats.totalUnrealized >= 0 ? '+' : ''}{totalStats.totalUnrealized < 0 ? '-' : ''}<MaskedValue value={Math.abs(totalStats.totalUnrealized).toLocaleString(undefined, { maximumFractionDigits: 0 })} prefix="$" />
              </div>
            </div>
            <div>
              <div className="text-xs text-gray-500 font-bold mb-1">REALIZED (å·²è½è¢‹)</div>
              <div className={`text-xl font-bold ${totalStats.totalRealized >= 0 ? 'text-black' : 'text-red-600'}`}>
                {totalStats.totalRealized >= 0 ? '+' : ''}{totalStats.totalRealized < 0 ? '-' : ''}<MaskedValue value={Math.abs(totalStats.totalRealized).toLocaleString(undefined, { maximumFractionDigits: 0 })} prefix="$" />
              </div>
            </div>
          </div>
        </div>

        {/* Sorting */}
        <div className="flex gap-2 justify-end">
           <button onClick={() => setSortMode('value')} className={`text-[10px] font-bold px-2 py-1 rounded border-2 border-transparent ${sortMode==='value' ? 'bg-black text-white border-black' : 'text-gray-400 hover:text-black'}`}>VALUE</button>
           <button onClick={() => setSortMode('pnl')} className={`text-[10px] font-bold px-2 py-1 rounded border-2 border-transparent ${sortMode==='pnl' ? 'bg-black text-white border-black' : 'text-gray-400 hover:text-black'}`}>PNL</button>
           <button onClick={() => setSortMode('name')} className={`text-[10px] font-bold px-2 py-1 rounded border-2 border-transparent ${sortMode==='name' ? 'bg-black text-white border-black' : 'text-gray-400 hover:text-black'}`}>NAME</button>
        </div>

        {/* === Asset List === */}
        <div className="space-y-4">
          {sortedAssets.map(asset => {
            const unrealizedPercent = (asset.currentAmount * asset.avgPrice) > 0 ? (asset.unrealizedPnL / (asset.currentAmount * asset.avgPrice)) * 100 : 0;
            const isCalcOpen = activeCalcId === asset.id;
            const dca = isCalcOpen ? getDCAProjection(asset) : null;
            
            const allocationPct = totalStats.totalValue > 0 ? (asset.marketValue / totalStats.totalValue) * 100 : 0;
            const isWhale = allocationPct > 20;
            const isMooning = asset.roi >= 2;
            const isRekt = asset.roi > 0 && asset.roi < 0.5;

            return (
              <div key={asset.id} className="pixel-box p-0">
                <div className="p-4 relative">
                  <div className="absolute top-4 right-4 flex gap-1">
                     {isWhale && <span className="text-[10px] bg-black text-white px-1 font-bold border border-black flex items-center gap-1"><Anchor size={8}/> {allocationPct.toFixed(0)}%</span>}
                     {isMooning && <span className="text-[10px] bg-green-100 text-green-700 px-1 font-bold border border-green-700 flex items-center gap-1"><Trophy size={8}/> {asset.roi.toFixed(1)}x</span>}
                     {isRekt && <span className="text-[10px] bg-red-100 text-red-700 px-1 font-bold border border-red-700 flex items-center gap-1"><AlertTriangle size={8}/> REKT</span>}
                  </div>

                  <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-black text-white flex items-center justify-center font-bold text-lg border-2 border-black" style={{backgroundColor: COIN_COLORS[asset.symbol] || '#000'}}>{asset.symbol[0]}</div>
                      <div>
                        <div className="font-black text-xl flex items-center gap-2">
                          {asset.symbol}
                        </div>
                        <div className="text-xs text-gray-500 font-bold mt-1 flex items-center gap-2">
                           <span><MaskedValue value={asset.currentPrice > 0 ? asset.currentPrice : '---'} /></span>
                           <span className="text-gray-300">|</span>
                           <span>Avg: <MaskedValue value={asset.avgPrice > 0 ? asset.avgPrice.toLocaleString(undefined, { maximumFractionDigits: 4 }) : '0'} /></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="flex justify-between items-end border-t-2 border-dashed border-gray-100 pt-3 mb-3">
                     <div>
                       <div className="text-[10px] font-bold text-gray-400">HOLDINGS</div>
                       <div className="font-bold text-sm"><MaskedValue value={asset.currentAmount.toLocaleString()} prefix="" /></div>
                     </div>
                     <div className="text-right">
                       <div className="font-bold text-lg"><MaskedValue value={asset.marketValue.toLocaleString(undefined, { maximumFractionDigits: 0 })} prefix="$" /></div>
                       <div className={`text-sm font-bold ${asset.unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                         {asset.unrealizedPnL >= 0 ? '+' : ''}{asset.unrealizedPnL < 0 ? '-' : ''}{Math.abs(unrealizedPercent).toFixed(2)}%
                       </div>
                     </div>
                  </div>

                  <div className="flex gap-2">
                     <button onClick={() => setActiveHistoryId(asset.id)} className="flex-1 pixel-btn bg-white py-2 text-xs hover:bg-gray-50"><History size={14} /> äº¤æ˜“è®°å½•</button>
                     <button onClick={() => { if (activeCalcId === asset.id) { setActiveCalcId(null); } else { setActiveCalcId(asset.id); setCalcPrice(asset.currentPrice || asset.avgPrice); setCalcInput(''); setCalcMode('amount'); } }} className={`flex-1 pixel-btn bg-white py-2 text-xs ${isCalcOpen ? '!bg-black !text-white' : 'hover:bg-gray-50'}`}><Zap size={14} /> {isCalcOpen ? 'å…³é—­æ¨æ¼”' : 'è¡¥ä»“æ¨æ¼”'}</button>
                  </div>
                </div>

                {isCalcOpen && (
                  <div className="bg-gray-50 border-t-4 border-black p-4 animate-in slide-in-from-top-2">
                    <div className="flex justify-between items-center mb-4">
                      <div className="text-xs font-bold flex items-center gap-1"><Calculator size={14} /> SIMULATOR</div>
                      <div className="flex border-2 border-black bg-white">
                        <button onClick={() => setCalcMode('amount')} className={`px-2 py-1 text-[10px] font-bold ${calcMode === 'amount' ? 'bg-black text-white' : 'text-gray-500'}`}>æŒ‰é‡‘é¢</button>
                        <button onClick={() => setCalcMode('quantity')} className={`px-2 py-1 text-[10px] font-bold ${calcMode === 'quantity' ? 'bg-black text-white' : 'text-gray-500'}`}>æŒ‰æ•°é‡</button>
                        <button onClick={() => setCalcMode('risk_free')} className={`px-2 py-1 text-[10px] font-bold ${calcMode === 'risk_free' ? 'bg-black text-white' : 'text-green-600'}`}>å‡ºæœ¬</button>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                      <div><label className="text-[10px] font-bold text-gray-500 block mb-1">ä»·æ ¼ ($)</label><input type="number" className="pixel-input" value={calcPrice} onChange={e => setCalcPrice(e.target.value)} /></div>
                      <div>
                        <label className="text-[10px] font-bold text-gray-500 block mb-1">{calcMode === 'risk_free' ? 'ç›®æ ‡' : (calcMode === 'amount' ? 'æŠ•å…¥ (U)' : 'æ•°é‡')}</label>
                        {calcMode === 'risk_free' ? (
                          <div className="pixel-input bg-gray-200 text-gray-500 text-xs flex justify-center">æ”¶å›æœ¬é‡‘</div>
                        ) : (
                          <input type="number" className="pixel-input" value={calcInput} onChange={e => setCalcInput(e.target.value)} placeholder="500" />
                        )}
                      </div>
                    </div>
                    {dca && <div className="bg-white border-2 border-black p-3">{dca.type === 'risk_free' ? (<div className="text-center"><div className="text-xs text-gray-500 font-bold mb-1">å›æœ¬éœ€å–å‡º</div><div className={`text-xl font-black ${dca.isProfitable ? 'text-green-600' : 'text-red-600'}`}>{dca.isProfitable ? dca.amountToSell.toFixed(4) : 'æ— æ³•å‡ºæœ¬'}</div></div>) : (<><div className="flex justify-between items-end mb-2"><div className="text-xs text-gray-500 font-bold">è¡¥ä»“åå‡ä»·</div><div className="text-xl font-black bg-black text-white px-2">${dca.newAvg.toFixed(4)}</div></div><div className="flex justify-between text-xs text-gray-500 border-t border-gray-200 pt-2"><span>è·å¾—: {dca.buyAmount.toFixed(4)}</span><span className="text-green-600 font-bold">é™å¹…: {dca.drop.toFixed(2)}%</span></div></>)}</div>}
                  </div>
                )}
              </div>
            );
          })}
        </div>

        <button onClick={() => setIsAddingNewCoin(true)} className="pixel-btn bg-white w-full py-4 text-gray-400 border-dashed hover:border-black hover:text-black"><Plus /> ADD NEW ASSET</button>

        {/* === Modals === */}

        {/* War Room Modal */}
        {isWarRoomOpen && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div className="pixel-box w-full max-w-lg bg-white h-[600px] flex flex-col relative animate-in zoom-in-95 duration-200">
               <div className="bg-black text-white p-3 flex justify-between items-center border-b-4 border-black">
                 <div className="flex items-center gap-2">
                   <Briefcase className="text-white" size={20}/>
                   <span className="font-black text-xl tracking-tight">WAR ROOM</span>
                 </div>
                 <button onClick={() => setIsWarRoomOpen(false)} className="text-white hover:text-gray-300"><X size={24}/></button>
               </div>
               
               <div className="flex overflow-x-auto border-b-2 border-gray-200 no-scrollbar p-1 gap-1 bg-gray-50">
                  <div onClick={()=>setWarRoomTab('position')} className={`wr-tab ${warRoomTab==='position'?'active':''}`}>ä»“ä½</div>
                  <div onClick={()=>setWarRoomTab('kelly')} className={`wr-tab ${warRoomTab==='kelly'?'active':''}`}>å‡¯åˆ©</div>
                  <div onClick={()=>setWarRoomTab('drawdown')} className={`wr-tab ${warRoomTab==='drawdown'?'active':''}`}>å›æœ¬</div>
                  <div onClick={()=>setWarRoomTab('avgdown')} className={`wr-tab ${warRoomTab==='avgdown'?'active':''}`}>å¹³å‡</div>
                  <div onClick={()=>setWarRoomTab('compound')} className={`wr-tab ${warRoomTab==='compound'?'active':''}`}>å¤åˆ©</div>
                  <div onClick={()=>setWarRoomTab('ruin')} className={`wr-tab ${warRoomTab==='ruin'?'active':''}`}>ç ´äº§</div>
               </div>

               <div className="p-6 flex-1 overflow-y-auto">
                  {warRoomTab === 'position' && <WarRoomTool_Position />}
                  {warRoomTab === 'kelly' && <WarRoomTool_Kelly />}
                  {warRoomTab === 'drawdown' && <WarRoomTool_Drawdown />}
                  {warRoomTab === 'avgdown' && <WarRoomTool_AvgDown />}
                  {warRoomTab === 'compound' && <WarRoomTool_Compound />}
                  {warRoomTab === 'ruin' && <WarRoomTool_Ruin />}
               </div>
            </div>
          </div>
        )}

        {/* Global Settings / Backup / Cloud Modal */}
        {isSettingsOpen && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div className="pixel-box w-full max-w-lg bg-white h-[600px] flex flex-col relative">
              <div className="flex items-center justify-between p-4 border-b-2 border-gray-200">
                <h2 className="text-xl font-black flex items-center gap-2"><Settings size={20}/> SETTINGS</h2>
                <button onClick={() => setIsSettingsOpen(false)} className="pixel-btn bg-white px-2 py-1 shadow-none border-0 hover:bg-gray-100"><X size={20}/></button>
              </div>

              {/* Settings Tabs */}
              <div className="flex border-b-2 border-gray-200 bg-gray-50">
                <button onClick={() => setSettingsTab('data')} className={`flex-1 py-3 text-xs font-bold ${settingsTab === 'data' ? 'bg-white border-b-2 border-black -mb-[2px]' : 'text-gray-400'}`}>DATA MANAGER</button>
                <button onClick={() => setSettingsTab('cloud')} className={`flex-1 py-3 text-xs font-bold ${settingsTab === 'cloud' ? 'bg-white border-b-2 border-black -mb-[2px]' : 'text-gray-400'}`}>CLOUD & SYNC</button>
              </div>
              
              <div className="p-6 flex-1 overflow-y-auto bg-gray-50">
                {settingsTab === 'data' ? (
                   <div className="space-y-4 animate-in slide-in-from-left-2">
                       <div className="bg-white p-4 border-2 border-gray-200 rounded">
                           <h3 className="font-bold mb-2 flex items-center gap-2"><Save size={16}/> Local Backup</h3>
                           <p className="text-xs text-gray-500 mb-4">Download a .json file of your current portfolio state.</p>
                           <button onClick={handleGlobalBackup} className="pixel-btn bg-white py-3 w-full flex items-center justify-center gap-2 hover:bg-gray-50"><DownloadCloud size={16}/> DOWNLOAD JSON</button>
                       </div>
                       <div className="bg-white p-4 border-2 border-gray-200 rounded">
                           <h3 className="font-bold mb-2 flex items-center gap-2"><Upload size={16}/> Restore Data</h3>
                           <p className="text-xs text-gray-500 mb-4">Overwrite current state with a backup file.</p>
                           <div className="relative"><button className="pixel-btn bg-white py-3 w-full flex items-center justify-center gap-2 hover:bg-gray-50"><Upload size={16}/> SELECT FILE</button><input type="file" accept=".json" onChange={handleGlobalRestore} className="absolute inset-0 opacity-0 cursor-pointer"/></div>
                       </div>
                   </div>
                ) : (
                   <div className="space-y-6 animate-in slide-in-from-right-2">
                       {/* Firebase Config Section */}
                       <div className="bg-white p-4 border-2 border-gray-200 rounded relative overflow-hidden">
                           <div className="flex justify-between items-center mb-3">
                               <h3 className="font-bold flex items-center gap-2 text-orange-600"><Database size={16}/> Firebase Sync</h3>
                               <div className={`text-[10px] font-bold px-2 py-0.5 rounded ${firebaseStatus === 'connected' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{firebaseStatus.toUpperCase()}</div>
                           </div>
                           <p className="text-[10px] text-gray-500 mb-2">Paste your Firebase Config below. Supports raw JS object pasting (no need to format as JSON).</p>
                           <textarea 
                             className="pixel-input h-24 text-[10px] font-mono mb-2 py-2" 
                             placeholder='const firebaseConfig = { apiKey: "..." };'
                             value={firebaseConfigInput}
                             onChange={(e) => setFirebaseConfigInput(e.target.value)}
                           />
                           
                           {/* Error / Success Feedback Area */}
                           {firebaseParseError ? (
                               <div className="text-[10px] font-bold text-orange-500 flex items-center gap-1">
                                   <AlertTriangle size={10}/> {firebaseParseError}
                               </div>
                           ) : (
                               firebaseConfigInput && !firebaseParseError && (
                                   <div className="text-[10px] font-bold text-green-600 flex items-center gap-1">
                                       <Check size={10}/> Valid Config (Parsed & Saved)
                                   </div>
                               )
                           )}

                           <div className="text-[10px] text-gray-400 mt-1">Status: {firebaseStatus === 'connecting' ? 'Connecting...' : (firebaseStatus === 'connected' ? 'Real-time Sync Active' : 'Offline')}</div>
                       </div>

                       {/* Telegram Config Section */}
                       <div className="bg-white p-4 border-2 border-gray-200 rounded">
                           <h3 className="font-bold flex items-center gap-2 text-blue-500 mb-3"><MessageSquare size={16}/> Telegram Bot</h3>
                           
                           <div className="space-y-3 mb-4">
                               <div>
                                   <label className="text-[10px] font-bold text-gray-500 flex items-center gap-1"><Key size={10}/> BOT TOKEN</label>
                                   <input className="pixel-input text-xs" placeholder="123456:ABC-DEF..." value={cloudConfig.tgToken} onChange={e=>saveCloudConfig({...cloudConfig, tgToken: e.target.value})}/>
                               </div>
                               <div>
                                   <label className="text-[10px] font-bold text-gray-500 flex items-center gap-1"><MessageSquare size={10}/> CHAT ID</label>
                                   <input className="pixel-input text-xs" placeholder="12345678" value={cloudConfig.tgChatId} onChange={e=>saveCloudConfig({...cloudConfig, tgChatId: e.target.value})}/>
                               </div>
                           </div>
                           
                           <div className="flex gap-2">
                               <div className="flex-1 bg-gray-50 border border-gray-200 p-2 rounded flex flex-col justify-center items-center text-center">
                                   <span className="text-[10px] font-bold text-gray-400">AUTO BACKUP</span>
                                   <span className={`text-xs font-bold ${tgLastBackup ? 'text-green-600' : 'text-gray-300'}`}>{tgLastBackup ? 'ACTIVE' : 'IDLE'}</span>
                               </div>
                               <button 
                                 onClick={handleTgPull} 
                                 disabled={isPullingTg || !cloudConfig.tgToken}
                                 className="flex-1 pixel-btn bg-white text-xs font-bold flex flex-col justify-center gap-1 disabled:opacity-50"
                               >
                                  {isPullingTg ? <Loader2 size={16} className="animate-spin"/> : <Cloud size={16}/>}
                                  <span>PULL FROM TG</span>
                               </button>
                           </div>
                           <p className="text-[10px] text-gray-400 mt-2 text-center">
                              Send a JSON message to your bot, then click "Pull" to sync it here.
                           </p>
                       </div>
                   </div>
                )}
              </div>
            </div>
          </div>
        )}

        {isImporting && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div className="pixel-box w-full max-w-lg bg-white p-6 relative animate-in zoom-in-95 duration-200 flex flex-col h-[500px]">
              <button onClick={()=>{setIsImporting(false);setImportPreview(null);setImportText('')}} className="absolute top-4 right-4 pixel-btn bg-white px-2 py-1 shadow-none border-0 hover:bg-gray-100"><X size={20}/></button>
              <h2 className="text-xl font-black mb-2 flex items-center gap-2"><FileSpreadsheet size={24}/> BULK IMPORT</h2>
              
              {!importPreview ? (
                <>
                  <p className="text-xs text-gray-500 mb-4">Paste data from Excel, CSV, or JSON. Columns should be: <span className="font-bold">Date, Type, Price, Amount</span>.</p>
                  <textarea className="pixel-input w-full flex-1 font-mono text-xs mb-4 shadow-none focus:shadow-sm py-2 resize-none" placeholder={`Example:\n2024-01-01, BUY, 42000, 0.5\n2024-02-01, SELL, 45000, 0.1\n...`} value={importText} onChange={e=>setImportText(e.target.value)}/>
                  <div className="grid grid-cols-2 gap-3 mt-auto">
                      <button onClick={()=>setIsImporting(false)} className="pixel-btn bg-white h-[42px] font-bold text-xs hover:bg-gray-50">CANCEL</button>
                      <button onClick={handlePreview} disabled={!importText} className={`pixel-btn h-[42px] font-bold text-xs ${!importText ? 'opacity-50 bg-gray-100 cursor-not-allowed' : 'primary !bg-black !text-white'}`}>NEXT: PREVIEW</button>
                  </div>
                </>
              ) : (
                <>
                  <div className="flex items-center justify-between mb-4">
                     <p className="text-xs text-gray-500">Found <span className="font-bold text-black">{importPreview.length}</span> valid transactions.</p>
                     <button onClick={()=>setImportPreview(null)} className="text-[10px] font-bold underline">Edit Raw Text</button>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto border-2 border-gray-200 bg-gray-50 p-2 mb-4 rounded">
                     {importPreview.length === 0 ? (
                         <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-2">
                             <AlertTriangle size={24}/>
                             <span className="text-xs">No valid data found. Check format.</span>
                         </div>
                     ) : (
                         <table className="w-full text-[10px] text-left">
                             <thead>
                                 <tr className="border-b-2 border-gray-300">
                                     <th className="pb-1 pl-1">DATE</th>
                                     <th className="pb-1">TYPE</th>
                                     <th className="pb-1 text-right">PRICE</th>
                                     <th className="pb-1 text-right pr-1">AMOUNT</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 {importPreview.map((row, i) => (
                                     <tr key={i} className="border-b border-gray-200 last:border-0 hover:bg-white">
                                         <td className="py-2 pl-1 font-mono">{row.date}</td>
                                         <td className="py-2">
                                             <span className={`px-1 rounded font-bold ${row.type==='BUY'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{row.type}</span>
                                         </td>
                                         <td className="py-2 text-right font-mono">${row.price.toLocaleString()}</td>
                                         <td className="py-2 text-right font-mono pr-1">{row.amount}</td>
                                     </tr>
                                 ))}
                             </tbody>
                         </table>
                     )}
                  </div>

                  <div className="grid grid-cols-2 gap-3 mt-auto">
                      <button onClick={()=>setImportPreview(null)} className="pixel-btn bg-white h-[42px] font-bold text-xs hover:bg-gray-50">BACK</button>
                      <button onClick={handleConfirmImport} disabled={importPreview.length === 0} className={`pixel-btn h-[42px] font-bold text-xs ${importPreview.length === 0 ? 'opacity-50 cursor-not-allowed' : 'primary !bg-black !text-white'}`}>CONFIRM IMPORT</button>
                  </div>
                </>
              )}
            </div>
          </div>
        )}
        
        {/* The Add New Coin Modal */}
        {isAddingNewCoin && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div className="pixel-box w-full max-w-md bg-white p-6 relative">
              <button onClick={()=>setIsAddingNewCoin(false)} className="absolute top-4 right-4 pixel-btn bg-white px-2 py-1 shadow-none border-0 hover:bg-gray-100"><X size={20}/></button>
              <h2 className="text-xl font-black mb-4 flex items-center gap-2"><Search size={20}/> SELECT TOKEN</h2>
              <div className="relative mb-6">
                <input autoFocus className="pixel-input text-lg uppercase" value={newCoinSearch} onChange={e=>{setNewCoinSearch(e.target.value);setSelectedCoin(null);setAddError('');}}/>
                <div className="absolute top-full left-0 w-full bg-white border-2 border-black border-t-0 max-h-48 overflow-y-auto z-50 shadow-xl">
                  {filteredCoins.map(coin=>(
                    <div key={coin.id} onMouseDown={(e)=>{e.preventDefault();selectCoin(coin);}} className="p-3 cursor-pointer border-b border-gray-100 hover:bg-gray-100 flex justify-between items-center">
                      <span className="font-bold flex items-center gap-2">{coin.symbol}</span>
                      <span className="text-xs opacity-70 truncate max-w-[150px]">{coin.name}</span>
                    </div>
                  ))}
                </div>
              </div>
              {selectedCoin && (
                <div className="mb-4 p-3 bg-gray-100 border-2 border-black flex items-center gap-3">
                  <CheckCircle2 className="text-green-600"/>
                  <div>
                    <div className="font-bold text-sm">SELECTED: {selectedCoin.symbol}</div>
                    <div className="text-xs text-gray-500">{selectedCoin.name}</div>
                  </div>
                </div>
              )}
              {addError && <div className="mb-4 p-3 bg-red-50 text-red-600 border-2 border-red-200 text-xs font-bold">{addError}</div>}
              <button disabled={!selectedCoin} onClick={confirmAddCoin} className={`pixel-btn bg-white primary w-full py-3 ${!selectedCoin?'opacity-50':'!bg-black !text-white'}`}>CONFIRM ADDITION</button>
            </div>
          </div>
        )}
        
        {activeHistoryId && !isImporting && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4">
            <div className="pixel-box w-full max-w-lg bg-white h-[85vh] sm:h-auto sm:max-h-[85vh] flex flex-col relative animate-in slide-in-from-bottom-10">
              <div className="p-4 border-b-4 border-gray-900 flex justify-between items-center bg-gray-50">
                 <div className="flex items-center gap-2"><h2 className="text-xl font-black">{assets.find(a=>a.id===activeHistoryId)?.symbol} HISTORY</h2></div>
                 <div className="flex gap-2 items-center">
                   <button onClick={() => setIsImporting(true)} className="pixel-btn bg-white w-9 h-9 flex items-center justify-center shadow-none hover:bg-gray-100"><FileSpreadsheet size={18} /></button>
                   <button onClick={() => handleExport('json')} className="pixel-btn bg-white w-9 h-9 flex items-center justify-center shadow-none hover:bg-gray-100"><FileJson size={18} /></button>
                   <button onClick={() => handleExport('md')} className="pixel-btn bg-white w-9 h-9 flex items-center justify-center shadow-none hover:bg-gray-100"><FileText size={18} /></button>
                   <div className="w-[1px] h-6 bg-gray-300 mx-1"></div>
                   <button onClick={() => handleDeleteAsset(activeHistoryId)} className={`pixel-btn w-9 h-9 flex items-center justify-center shadow-none transition-all ${deleteConfirmId === activeHistoryId ? '!bg-red-600 !text-white border-red-600' : '!bg-black !text-white border-black'}`}>{deleteConfirmId === activeHistoryId ? <span className="font-bold text-lg">?</span> : <Trash2 size={18}/>}</button>
                   <button onClick={()=>setActiveHistoryId(null)} className="pixel-btn bg-white w-9 h-9 flex items-center justify-center shadow-none hover:bg-gray-100"><X size={20} /></button>
                 </div>
              </div>
              <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100">
                {assets.find(a=>a.id===activeHistoryId)?.transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(tx => {
                   const tag = STRATEGY_TAGS.find(t => t.id === tx.strategy);
                   return (
                     <div key={tx.id} className="bg-white border-2 border-gray-300 p-3 flex justify-between items-center group hover:border-black">
                        <div className="flex items-center gap-3">
                           <div className={`w-8 h-8 flex items-center justify-center text-white font-bold text-xs border border-black ${tx.type==='BUY'?'bg-green-600':'bg-red-500'}`}>{tx.type==='BUY'?'ä¹°':'å–'}</div>
                           <div>
                              <div className="font-bold text-sm flex items-center gap-2">
                                 {tx.type==='BUY'?'ä¹°å…¥':'å–å‡º'} <MaskedValue value={tx.amount} prefix="" />
                                 {tag && <span className="text-[10px] px-1 border rounded text-white font-normal" style={{backgroundColor: tag.color, borderColor: tag.color}}>{tag.label}</span>}
                              </div>
                              <div className="text-xs text-gray-500">@ <MaskedValue value={tx.price} /> on {tx.date}</div>
                           </div>
                        </div>
                        <button onClick={() => handleDeleteTx(activeHistoryId, tx.id)} className={`text-xs font-bold px-2 py-1 rounded transition-all flex items-center ${deleteTxConfirmId === tx.id ? 'bg-red-600 text-white' : 'text-gray-300 hover:text-red-500'}`}>{deleteTxConfirmId === tx.id ? '?' : <Trash2 size={14}/>}</button>
                     </div>
                   )
                })}
              </div>
              
              <div className="p-4 border-t-4 border-gray-900 bg-white">
                <div className="flex flex-col gap-3">
                  <div className="grid grid-cols-2 gap-3"><button onClick={()=>setTxForm({...txForm, type:'BUY'})} className={`pixel-btn h-[42px] text-xs font-bold ${txForm.type==='BUY'?'!bg-black !text-white':'bg-white'}`}>BUY (ä¹°å…¥)</button><button onClick={()=>setTxForm({...txForm, type:'SELL'})} className={`pixel-btn h-[42px] text-xs font-bold ${txForm.type==='SELL'?'!bg-black !text-white':'bg-white'}`}>SELL (å–å‡º)</button></div>
                  <div className="grid grid-cols-2 gap-3"><input type="number" className="pixel-input h-[42px] text-sm" placeholder="Price ($)" value={txForm.price} onChange={e=>setTxForm({...txForm, price:e.target.value})}/><input type="number" className="pixel-input h-[42px] text-sm" placeholder="Amount" value={txForm.amount} onChange={e=>setTxForm({...txForm, amount:e.target.value})}/></div>
                  <div className="flex gap-2">
                     {STRATEGY_TAGS.map(tag => (
                       <button 
                         key={tag.id}
                         onClick={() => setTxForm({...txForm, strategy: tag.id})}
                         className={`flex-1 py-1 text-[10px] font-bold border-2 rounded ${txForm.strategy === tag.id ? 'text-white' : 'bg-white text-gray-400 border-gray-200'}`}
                         style={txForm.strategy === tag.id ? { backgroundColor: tag.color, borderColor: tag.color } : {}}
                       >
                         {tag.label}
                       </button>
                     ))}
                  </div>
                  <div className="relative h-[42px] w-[80%] mx-auto">
                     <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><Calendar size={16}/></div>
                     <input type="date" className="pixel-input h-full w-full text-sm pl-10" value={txForm.date} onChange={e=>setTxForm({...txForm, date:e.target.value})}/>
                  </div>
                  <button onClick={handleAddTx} className="pixel-btn primary h-[42px] w-full !bg-black !text-white text-xs font-bold flex items-center justify-center gap-2"><Save size={14}/> SAVE RECORD</button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}



